import { useEffect, useRef } from 'react'
import Mound from './Mound'
import Sign from '../Sign'
import { motion, AnimatePresence, useAnimate } from 'motion/react'
import AboutMarmot from './AboutMarmot'
import ServicesMarmot from './ServicesMarmot'
import { useLocation } from 'react-router-dom'
import WorkMarmot from './WorkMarmot'

const Marmot = ({ handleClick, isInView, cursorRef, setCursorActive }) => {
    const signRef = useRef(null)
    const containerRef = useRef(null)
    const [scope, animate] = useAnimate()

    // Track animation state with location changes
    const prevLocation = useRef(null)
    const location = useLocation()

    const aboutPage = location.pathname === '/'
    const servicesPage = location.pathname === '/services'
    const workPage = location.pathname === '/work'

    const handleHover = () => {
        aboutPage && (
            animate('.mouth', {
                opacity: [0, 1, 1],
                x: [-1, 0, 0],
                d: [
                    'M189.421 60.5023C189.261 62.7323 188.761 70.3923 193.991 72.7523C194.591 72.8923 195.221 72.9723 195.891 72.9523C196.981 72.9223 197.991 72.7023 198.931 72.3423C202.211 69.8923 203.431 63.3523 202.261 60.9923C200.191 60.3223 197.961 59.2723 196.341 57.6123C196.341 57.6123 193.281 59.4623 189.431 60.5123L189.421 60.5023Z',
                    'M182.882 60.1649C182.882 60.1649 185.972 72.2949 194.062 72.1049C202.152 71.915 206.192 61.115 206.192 61.115C206.192 61.115 198.512 60.6449 194.522 56.5549C194.522 56.5549 188.132 59.9749 182.892 60.1649H182.882Z',
                ],
                time: [0, 0.125, 1],
                duration: 0.15,
            })
        )
        aboutPage && (
            animate('.tongue', {
                opacity: [0, 1, 1],
                d: [
                    'M202.321 66.3425C196.581 66.0225 192.851 69.6825 191.671 71.0325C192.291 71.7325 193.051 72.3325 193.981 72.7525C194.261 72.8225 194.551 72.8725 194.851 72.9025C194.891 72.9025 194.931 72.9025 194.961 72.9125C195.261 72.9425 195.561 72.9625 195.881 72.9525C196.971 72.9225 197.981 72.7025 198.921 72.3425C200.631 71.0625 201.771 68.6725 202.321 66.3425Z',
                    'M203.602 66.4429C194.632 63.9129 189.392 71.1829 189.392 71.182C190.702 72.1029 192.252 72.6729 194.062 72.6329C198.412 72.5329 201.592 69.3529 203.602 66.4429Z'
                ],
                time: [0, .5, 1],
                duration: 0.15
            })
        )
    }

    const handleStopHover = () => {
        aboutPage && (
            animate('.mouth', {
                opacity: [0],
                duration: .45,
            })
        )
        aboutPage && (
            animate('.tongue', {
                opacity: [0],
                duration: .45,
            })
        )
    }

    useEffect(() => {
        const handlePageChange = () => {
            if (prevLocation.current !== location.pathname) {
                prevLocation.current = location.pathname
            }
        }

        window.addEventListener('locationchange', handlePageChange)
        return () => window.removeEventListener('locationchange', handlePageChange)
    }, [location])


    return (
        <>
            <motion.div
                className='marmot-wrapper'
                whileHover={() => {
                    containerRef.current.style.pointerEvents = 'none'
                    signRef.current?.classList.add('hover')
                    aboutPage && setCursorActive(true)
                    handleHover()
                }}
                onHoverStart={() => {
                    signRef.current?.classList.add('hover')
                    aboutPage && setCursorActive(true)
                    handleHover()
                }}
                onHoverEnd={() => {
                    signRef.current?.classList.remove('hover')
                    aboutPage && setCursorActive(false)
                    handleStopHover()
                }}
            >
                {!isInView && aboutPage && (
                    <Sign
                        ref={signRef}
                        
                        handleClick={handleClick}
                    />
                )}
                <div
                    className='marmot-container'
                    ref={containerRef}
                >
                    <svg
                        width='429'
                        height='218'
                        viewBox='0 0 429 218'
                        fill='none'
                    >
                        <Mound>
                            <AnimatePresence>
                                {aboutPage && <AboutMarmot key='about' mouthScope={scope} />}
                                {servicesPage && <ServicesMarmot key='services' />}
                                {workPage && <WorkMarmot key='work' />}
                            </AnimatePresence>
                        </Mound>

                        {(servicesPage || workPage) && (
                            <>
                                <g id='services-coffee-cup'>
                                    <path
                                        d='M354.998 128.591C354.998 130.841 345.038 132.661 332.748 132.661C320.458 132.661 310.498 130.841 310.498 128.591C310.498 126.341 320.458 124.521 332.748 124.521C345.038 124.521 354.998 126.341 354.998 128.591Z'
                                        fill='#8A8F99'
                                    />
                                    <path
                                        d='M313.248 133.361C313.248 133.361 315.808 129.851 320.168 129.761C324.528 129.671 331.348 130.901 334.568 130.331C337.788 129.761 345.278 129.951 349.058 130.901C352.838 131.851 353.508 135.261 353.508 135.261L339.198 139.901C339.198 139.901 313.338 136.581 313.238 133.361H313.248Z'
                                        fill='#662621'
                                    />
                                    <motion.path
                                        d='M345.508 118.06C344.628 116.9 343.468 115.91 342.468 115.34C340.958 114.49 339.188 114.27 337.468 114.01C335.758 113.75 333.978 113.41 332.598 112.36C331.208 111.32 330.358 109.38 331.068 107.8C331.578 106.67 332.478 106.4 333.528 106.03C334.688 105.62 335.838 104.89 336.558 103.88C337.068 103.17 337.468 101.88 336.858 101.11C337.038 101.94 336.508 102.8 335.808 103.27C335.108 103.74 334.238 103.91 333.398 104.07C331.898 104.35 330.378 104.61 328.998 105.27C328.318 105.59 327.698 106 327.088 106.44C325.788 107.4 324.578 108.54 323.808 109.96C323.038 111.38 322.748 113.12 323.308 114.64C323.848 116.12 325.078 117.16 326.248 118.14C326.878 118.66 327.478 119.2 328.078 119.74C328.598 120.21 329.328 120.5 329.748 121.07C330.408 121.97 329.928 123.3 329.108 124.06C328.288 124.82 327.218 125.24 326.338 125.93C325.218 126.81 324.258 128.02 323.328 129.09C322.828 129.66 322.358 130.26 322.078 130.96C321.798 131.66 321.738 132.47 322.048 133.16C322.388 133.89 323.098 134.37 323.828 134.71C325.368 135.43 326.928 135.71 328.198 136.91C329.338 137.99 330.158 139.46 330.198 141.06C330.248 142.91 329.308 144.69 328.028 146.03C326.748 147.37 325.138 148.35 323.558 149.31C326.578 148.8 329.668 148.27 332.328 146.77C334.728 145.42 337.508 142.53 337.238 139.51C337.008 136.96 334.708 133.28 332.128 132.66C331.098 132.41 329.578 132.04 329.858 131.02C329.928 130.76 330.128 130.55 330.328 130.37C332.478 128.43 335.598 128.17 338.388 127.41C340.748 126.77 342.988 125.7 344.978 124.28C345.988 123.56 346.838 122.69 346.838 121.36C346.838 120.26 346.278 119.09 345.488 118.05L345.508 118.06ZM340.598 123.45C340.198 123.87 339.638 124.1 339.098 124.32C337.088 125.13 335.088 125.94 333.078 126.75C334.438 125.79 335.678 124.66 336.748 123.4C337.528 122.48 338.258 121.31 337.948 120.15C337.398 118.09 334.518 117.93 333.688 116.1C336.978 115.4 341.068 117.63 341.258 121.18C341.298 121.99 341.148 122.86 340.598 123.45Z'
                                        fill='#E2E2E2'
                                        animate={{
                                            opacity: [0, 0.5, 0.5, 0],
                                            translateY: [25, -10],
                                        }}
                                        transition={{
                                            duration: 10,
                                            ease: 'linear',
                                            times: [0, 0.1, 0.85, 1],
                                            repeat: Infinity,
                                            repeatDelay: 1,
                                        }}
                                    />
                                    <path
                                        d='M332.748 132.671C321.068 132.671 311.488 131.021 310.578 128.921L315.118 163.601C315.768 168.611 320.018 172.381 325.078 172.441L342.118 172.631C347.468 172.691 351.948 168.591 352.358 163.251L355.008 128.831H354.968C354.298 130.971 344.608 132.671 332.758 132.671H332.748Z'
                                        fill='#C5C9D2'
                                    />
                                </g>
                                <g id='computer'>
                                    <path
                                        d='M158.158 193.83L200.698 179.21V176.37L131.728 167.37L84.8979 182.21'
                                        fill='#BBB8BB'
                                    />
                                    <path
                                        d='M158.158 193.83L200.698 179.21V176.37L131.728 167.37L84.8979 182.21'
                                        fill='#C1C1C1'
                                    />
                                    <path
                                        d='M94.5879 180.54L112.588 174.67L176.918 183.86L156.838 191.53L94.5879 180.54Z'
                                        fill='#A8A8A8'
                                    />
                                    <path
                                        d='M54.458 128.78L84.898 182.21L158.158 193.83V191.18L127.218 133.08L55.338 127.77L54.458 128.78Z'
                                        fill='#D6D6D6'
                                    />
                                </g>
                            </>
                        )}
                        {servicesPage && (
                            <motion.g
                                id='left-hand'
                                initial={{
                                    opacity: 0,
                                }}
                                animate={{
                                    opacity: 1,
                                }}
                                transition={{
                                    duration: 0.05,
                                    delay: 0.9,
                                }}
                                exit={{
                                    opacity: 0,
                                }}
                            >
                                <path
                                    d='M193.608 159.35C193.608 159.35 190.088 156.3 183.488 156.01C176.898 155.72 170.168 159.1 168.888 161.86C167.608 164.62 166.368 169.83 164.228 173.24C162.868 175.4 163.918 179.01 166.238 177.94C168.558 176.87 168.558 174.18 169.938 171.57C171.318 168.96 172.448 166.44 172.448 166.44C172.448 166.44 171.918 171.98 170.588 175.11C169.258 178.24 168.838 181.06 170.668 181.7C172.498 182.34 174.418 177.81 175.488 174.78C176.558 171.75 178.438 168.31 178.438 168.31C178.438 168.31 177.478 173.28 176.968 175.12C176.458 176.96 175.458 180.39 177.588 180.69C179.718 180.99 180.938 175.93 181.528 174.48C182.118 173.03 183.988 169.72 183.988 169.72C183.988 169.72 183.778 173.9 183.408 175.63C183.038 177.36 182.698 178.85 184.058 179.17C185.418 179.49 187.388 173.64 188.148 170.95C188.908 168.26 189.038 168.27 191.058 167.53C193.078 166.79 194.038 168.08 195.508 165.86C196.978 163.64 195.428 160.11 193.618 159.34L193.608 159.35Z'
                                    fill='#4F4030'
                                />
                                <path
                                    d='M165.618 174.89C165.618 174.89 164.548 174.7 163.848 176.72C163.148 178.74 163.278 182.4 163.278 182.4C163.278 182.4 165.108 178.93 165.738 177.66C166.368 176.39 166.058 175.51 165.608 174.88L165.618 174.89Z'
                                    fill='#281F17'
                                />
                                <path
                                    d='M171.358 178.23C171.358 178.23 170.288 178.04 169.588 180.06C168.888 182.08 169.018 185.74 169.018 185.74C169.018 185.74 170.848 182.27 171.478 181C172.108 179.73 171.798 178.85 171.348 178.22L171.358 178.23Z'
                                    fill='#281F17'
                                />
                                <path
                                    d='M178.248 177.22C178.248 177.22 177.178 177.03 176.478 179.05C175.778 181.07 175.908 184.73 175.908 184.73C175.908 184.73 177.738 181.26 178.368 179.99C178.998 178.72 178.688 177.84 178.238 177.21L178.248 177.22Z'
                                    fill='#281F17'
                                />
                                <path
                                    d='M184.708 176.72C184.708 176.72 183.908 176.58 183.388 178.09C182.868 179.6 182.958 182.34 182.958 182.34C182.958 182.34 184.328 179.74 184.798 178.8C185.268 177.86 185.038 177.19 184.708 176.72Z'
                                    fill='#281F17'
                                />
                            </motion.g>
                        )}
                        {workPage && (
                            <motion.g
                                id='left-hand'
                                initial={{
                                    opacity: 0,
                                }}
                                animate={{
                                    opacity: 1,
                                }}
                                transition={{
                                    duration: 0.05,
                                    delay: 0.9,
                                }}
                                exit={{
                                    opacity: 0,
                                }}
                            >
                                <path
                                    d='M193.608 159.35C193.608 159.35 190.088 156.3 183.488 156.01C176.898 155.72 170.168 159.1 168.888 161.86C167.608 164.62 166.368 169.83 164.228 173.24C162.868 175.4 163.918 179.01 166.238 177.94C168.558 176.87 168.558 174.18 169.938 171.57C171.318 168.96 172.448 166.44 172.448 166.44C172.448 166.44 171.918 171.98 170.588 175.11C169.258 178.24 168.838 181.06 170.668 181.7C172.498 182.34 174.418 177.81 175.488 174.78C176.558 171.75 178.438 168.31 178.438 168.31C178.438 168.31 177.478 173.28 176.968 175.12C176.458 176.96 175.458 180.39 177.588 180.69C179.718 180.99 180.938 175.93 181.528 174.48C182.118 173.03 183.988 169.72 183.988 169.72C183.988 169.72 183.778 173.9 183.408 175.63C183.038 177.36 182.698 178.85 184.058 179.17C185.418 179.49 187.388 173.64 188.148 170.95C188.908 168.26 189.038 168.27 191.058 167.53C193.078 166.79 194.038 168.08 195.508 165.86C196.978 163.64 195.428 160.11 193.618 159.34L193.608 159.35Z'
                                    fill='#4F4030'
                                />
                                <path
                                    d='M165.618 174.89C165.618 174.89 164.548 174.7 163.848 176.72C163.148 178.74 163.278 182.4 163.278 182.4C163.278 182.4 165.108 178.93 165.738 177.66C166.368 176.39 166.058 175.51 165.608 174.88L165.618 174.89Z'
                                    fill='#281F17'
                                />
                                <path
                                    d='M171.358 178.23C171.358 178.23 170.288 178.04 169.588 180.06C168.888 182.08 169.018 185.74 169.018 185.74C169.018 185.74 170.848 182.27 171.478 181C172.108 179.73 171.798 178.85 171.348 178.22L171.358 178.23Z'
                                    fill='#281F17'
                                />
                                <path
                                    d='M178.248 177.22C178.248 177.22 177.178 177.03 176.478 179.05C175.778 181.07 175.908 184.73 175.908 184.73C175.908 184.73 177.738 181.26 178.368 179.99C178.998 178.72 178.688 177.84 178.238 177.21L178.248 177.22Z'
                                    fill='#281F17'
                                />
                                <path
                                    d='M184.708 176.72C184.708 176.72 183.908 176.58 183.388 178.09C182.868 179.6 182.958 182.34 182.958 182.34C182.958 182.34 184.328 179.74 184.798 178.8C185.268 177.86 185.038 177.19 184.708 176.72Z'
                                    fill='#281F17'
                                />
                            </motion.g>
                        )}
                    </svg>
                </div>
            </motion.div>
        </>
    )
}

export default Marmot
